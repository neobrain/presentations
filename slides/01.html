<section><h2>Generative Programming in Action</h2><h3>Emulating the Nintendo 3DS</h3>
<div style="display:flex; justify-content:space-around">
<p style="width:25%; font-size:80%; color:#c0c0c0">Tony Wasserka<br><small>@fail_cluez</small></p>
<p style="width:25%; font-size:80%; color:#c0c0c0">C++::London<br><small>19 Feb 2018</small></p>
</div>
</section>

<section><h2>What this will be about</h2>
<ul>
<li $make_fragment("0")$>Introduction to the 3DS kernel interface</li>
<li $make_fragment("1")$>Claim: Metaprogramming is useful here</li> <!-- + language evolution has made it more accessible -->
<ul>
<li $make_fragment("2")$>It's more accessible than ever!</li>
</ul>
<li $make_fragment("3")$>Show off some common techniques</li> <!-- Stress that this is not a tutorial: "Focus on what can be done rather than how!" -->
</ul>

<p $make_fragment("4")$>First of all: Who am I?</p>
</section>

<section><h2>Who am I?</h2>
<ul>
<li>C++ enthusiast: Low-level &amp; type-safety</li> <!-- C++ makes the type system effective even for inherently untyped data -->
<li>Game console emulation: GC/Wii/3DS/PSP</li>
<div style="display:flex; justify-content:space-around; align-items:center">
<small style="text-align: center"><img src="images/ppsspp_logo.svg" height="100em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle"><br>PPSSPP</small>
<small style="text-align: center"><img src="images/dolphin_logo.svg" height="150em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle"><br>Dolphin</small>
<small style="text-align: center"><img src="images/citra_logo.svg" height="100em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle"><br>Citra</small><br>
</div>
<li>Twitter: @fail_cluez, GitHub: neobrain <img src="images/glitchedcube2.png" height="100em" style="border-radius:20px; vertical-align:middle"></li>
<li>Studied Physics, now working on GPU drivers</li>
</ul>
</section>

<section><h2>The Nintendo 3DS</h2>
<div style="display:flex; justify-direction:column">
<img src="images/3ds.png" height="250em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle">
<ul>
<li>Released in 2011</li>
<li $make_fragment("0")$>CPU: 2x ARM11 MPCore @ 268 MHz</li> <!-- "Big embedded system" -->
<li $make_fragment("0")$>GPU: DMP PICA200</li>
<li $make_fragment("0")$>RAM: 128 MB FCRAM, 6 MB VRAM</li>
<li $make_fragment("1")$>Software stack:
<ul $make_fragment("1")$>
<li>Microkernel (fully multitasking)</li>
<li>Microservices</li>
</ul>
</ul>
</div>
</section>

<section><h2>The 3DS Software Stack</h2> <!-- Three layers that are relevant to emulation -->
<div style="display:flex; justify-direction:column">
<img src="images/3ds.png" height="250em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle">
<table width="65%">
            <tr>
              <td class="fragment fade-in" data-fragment-index=2 colspan="6">
                <div style="display:flex; align-items:center; justify-content:space-between">
                  <div><font color="#40c030">Game/Application</font></div>
                  <div class="comment" style="font-size:17pt !important; text-align:right">Runs on emulated CPU</div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="fragment fade-in" data-fragment-index=1 colspan="6">
                <div style="display:flex; align-items:center; justify-content:space-between">
                  <font color="#e06130">Kernel: Horizon</font>
                  <div class="comment">API emulation</div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="fragment fade-in" data-fragment-index=0 colspan="6">
                <div style="display:flex; align-items:center; justify-content:space-between">
                   <font color="#d02030">ARM11 CPUs</font>
                   <div class="comment">Interpreter</div>
                </div>
              </td>
            </tr>
</table>
</div>
</section>

<section><h2>3DS System Calls</h2>
<p>Kernel↔Application interface: 130 system calls</p>
<ul>
<li $make_fragment("0")$>Memory management</li>
<li $make_fragment("1")$>Multi-Processing/Threading</li>
<li $make_fragment("2")$>Synchronisation</li>
<li $make_fragment("3")$>Inter-Process Communication</li>
<li $make_fragment("4")$>&#8230;</li>
</ul>
</section>

<section data-transition="slide-in fade-out"><h2>3DS System Calls</h2>
<p>System calls on hardware:</p>

<div style="display:flex; justify-content:space-around; align-items:center">
<img src="images/asm_svc_example.png" style="vertical-align:middle">
<div $make_fragment("0")$>⟶</div>
<div style="display:inline-block; text-align:center; vertical-align:middle" $make_fragment("0")$><ul><li>CPU software interrupt</li><li>Mode switch (to kernel)</li><li>OS interrupt handler</li><li>Mode switch (to userland)</li></ul></div>
</div>
<!-- Stress how SVCs read and write back from/to CPU registers to get arguments/return results -->
<pre style="visibility:hidden"><code class="cpp">struct CPUContext {
  uint32_t reg[16];
} cpu;
</code></pre>
</section>


<section data-transition="fade-in slide-out"><h2>3DS System Calls</h2>
<p>High-level emulation:</p>

<div style="display:flex; justify-content:space-around; align-items:center">
<img src="images/asm_svc_example.png" style="vertical-align:middle">
<div>⟶</div>
<div style="display:inline-block; text-align:center; vertical-align:middle">HandleSVC(cpu, 0x54);</div>
</div>
<pre><code class="cpp">struct CPUContext {
  uint32_t reg[16];
} cpu;
</code></pre>
</section>
