<section><h1>InterProcess Communication</h1>
  <img src="images/3ds.png" height="250em" style="border:none; background-color: transparent; box-shadow: none; vertical-align:middle">
</section>

<section><h2>InterProcess Communication</h2>
<p>IPC is crucial to everything:</p> <!-- NB: Crucial for games -->
<ul>
  <!-- TODO: Just display small graphics instead -->
  <li>Rendering graphics &amp; playing audio</li>
  <li>Accessing WiFi &amp; connecting to friends</li>
  <li>Loading assets &amp; saving progress</li>
  <li>…</li>
</ul>

<p $make_fragment("13")$>Protocol design:</p>
<ul>
<li $make_fragment("14")$>Client-Server architecture: Games &lt;-&gt; Services</li> <!-- TODO: Use proper arrow -->
<li $make_fragment("15")$>Request-response exchange via command blocks</li>
<li $make_fragment("16")$>Sensitive data is marshalled by the OS kernel<!-- NB: <br>
  (e.g. shared buffers or kernel object handles)--></li>
<li $make_fragment("17")$>Hierarchy: Abstraction, Access protection</li>
</ul>

Prototypical example of serialization in emulation:
* Requests should be decoded and handled by C++ functions
* C++ function return value should be encoded into response
</section>

<section class="animated-slide"><h2>X</h2>
<!--<div class="link-for-reload"><a class="link-for-reload">TODOSTUFF</a></div>-->
<div style="display:flex; flex-direction: row; justify-content:center; align-items:center">
<span>
<p>App: ReadFile</p>
<div class="original-ipc-cmd-block" style="text-align:left; border:solid 2.3px; border-radius:4px; font-size:0.6em; width:12em">
<span class="original-ipc-cmd-block-entry0">0x80: 0x0802'03'02 (header)</span><br>
<span class="original-ipc-cmd-block-entry1">0x84: 0x3bf</span><br> <!-- file descriptor -->
<span class="original-ipc-cmd-block-entry2">0x88: 0x200</span><br> <!-- low word of offset-->
<span class="original-ipc-cmd-block-entry3">0x8c: 0</span><br>
<span class="original-ipc-cmd-block-entry4">0x90: 0x100</span><br> <!-- low word of size-->
<span class="original-ipc-cmd-block-entry5">0x94: 0</span><br>
</div>
</span>
<img class="ipc-img" src="/images/stuff0.svg">
<span>
<p>Kernel</p>
<div class="copied-ipc-cmd-block" style="border:solid 2.3px; border-radius:4px; font-size:0.6em; width:10em">
<span class="kernel-ipc-cmd-block-entry0">0x80: Command header<br></span>
<span class="kernel-ipc-cmd-block-entry1">0x84: Argument 1<br></span>
<span class="kernel-ipc-cmd-block-entry2">0x88: Argument 2<br></span>
<span class="kernel-ipc-cmd-block-entry3">0x8c: …XX<br></span>
<span class="kernel-ipc-cmd-block-entry4">0x90: Argument 2<br></span>
<span class="kernel-ipc-cmd-block-entry5">0x94: …XX<br></span>
</div>
</span>
<img class="ipc-img" src="/images/stuff1.svg">
<span>
<p>Service</p>
<div class="original-ipc-cmd-block" style="visibility:hidden; border:solid 2.3px; border-radius:4px; font-size:0.6em; width:10em">
<span class="original-ipc-cmd-block-entry0">Command header<br></span>
<span class="original-ipc-cmd-block-entry1">Argument 1<br></span>
<span class="original-ipc-cmd-block-entry2">Argument 2<br></span>
<span class="original-ipc-cmd-block-entry3">…XX<br></span>
</div>
</span>
<h1 class="spin-gears"></h1>
</div>
</section>

<section><h3>Emulating IPC command handlers</h3>
<p style="margin-top:-15px; margin-bottom:0px">Common structure on handler dispatch:</p>
<ul>
  <li $make_fragment("0")$>Select C++ handler function based on command index<br>
  <pre><code class="cpp" style="font-size:90%">Result HandleReadFile(uint32_t, uint64_t, uint64_t, BufferPointerW)</code></pre></li>
  <li $make_fragment("1")$>Verify command header (number of parameters)<br>
  <pre><code class="cpp">(cmd_header &amp; 0xFF == 5) &nbsp;&amp;&amp;&nbsp; ((cmd_header &gt;&gt; 8) &amp; 0xff == 2)</code></pre></li>
  <li $make_fragment("2")$>Parse parameters from command block
  <table style="font-size:50%" align="center">
    <tr>
      <td style="text-align:center">header<br>0x8020205</td><td style="text-align:center">uint32<br>5</td><td style="text-align:center">uint64_lo<br>0xdeadbeef</td><td style="text-align:center">uint64_hi<br>0x5555</td><td style="text-align:center">uint64_lo<br>0xd00f</td><td style="text-align:center">uint64_hi<br>0</td><td style="text-align:center">buffer descriptor<br>…</td><td style="text-align:center">buffer addr<br>0x1ff00200</td>
    </tr>
  </table></li>
  <li $make_fragment("3")$>Invoke C++ handler function<br>
  <pre><code class="cpp">HandleStuff(5, 0x5555deadbeef, 0xd00f, BufferPointerW{0x1ff00200});</code></pre></li>
  <li $make_fragment("4")$>Write response back to command block
  <table style="font-size:60%">
    <tr>
      <td>header: 0x8020002</td><td>Result: 0x0</td>
    </tr>
  </table></li>
</ul>
</section>

<section><h3>Emulating IPC command handlers</h3>
  <!-- Screenshot/Browse 3dbrew instead here -->
  How often do we need to write this logic?
  <ul>
    <li $make_fragment("0")$>~40 active processes</li>
    <li $make_fragment("1")$>Each with ~30 IPC commands on average</li>
    <li $make_fragment("2")$>Manual glue to invoke the C++ handler required for each</li>
  </ul>
  <p $make_fragment("3")$>That is a lot of work. <!-- TODO: Consider reusing the "Repetitive logic" slide here instead --> <span $make_fragment("4")$>Or is it?</span></p>
  <p $make_fragment("5")$><b>Enter Generative Programming</b></p>
</section>
